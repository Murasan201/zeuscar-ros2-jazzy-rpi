# アジャイル＋TDD 開発運用ルール（共通利用版）

この文書は、アジャイル開発とテスト駆動開発（TDD）を組み合わせたチーム運営ルールを他プロジェクトでも再利用できるように定義したものです。個々のプロジェクト状況に応じて調整可能な可変項目を示しつつ、守るべき原則を明文化します。

> **マルチエージェント運用**：本パッケージでは、PM / Assignee によるマルチエージェント並列開発体制と worktree 管理を `docs/operations/generic_methodology/multi_agent_development_flow.md` に定義しています。新規 PM やスクラムマスターは本ルールと合わせて同ドキュメントを参照し、チケット割当からレポート報告までのフローを把握してください。

---

## 1. 目的と適用範囲
- アジャイル＋TDD を基盤に、短いフィードバックサイクルで品質と価値を継続的に向上させる。
- チーム規模は 3〜10 名を想定。複数チームで運用する場合はスクラム・オブ・スクラム等の連携プロセスを追加する。
- 本ルールはソフトウェア製品・ライブラリ・ツールの開発に適用できる。ハードウェア連携や研究開発など特殊要件がある場合は補足ルールを別途定義する。

## 2. 基本原則
- **透明性**：バックログ、テスト結果、リリース状況を常に共有状態に保つ。
- **短期反復**：スプリント長は 1〜2 週間を基準とし、価値のあるインクリメントを必ず提供する。
- **品質内蔵**：TDD を中核プロセスとし、テストが実装品質の最低ラインを保証する。
- **ドキュメント一貫性**：成果物・意思決定・ナレッジを単一リポジトリに集約し、索引を常時更新する。
- **継続的改善**：振り返りで得た改善アクションは次スプリントで確実に実行し、効果検証までを 1 サイクルとする。

## 3. ロールと責務
- **プロダクト責任者（PO）**：価値仮説の提示、バックログ優先順位付け、受け入れ基準の承認。
- **開発リード（TL/アーキテクト）**：技術方針の維持、アーキテクチャ決定のファシリテート、難易度調整。
- **開発担当（Dev）**：TDD に基づく実装、ペア／モブ開発によるナレッジ共有、レビュー参加。
- **品質担当（QA/テストリード）**：テスト戦略の策定、CI/CD の整備、非機能要件の検証計画。
- **スクラムマスター／アジャイルコーチ（任意）**：プロセス改善、阻害要因の除去、ファシリテーション。

## 4. スプリント運営フロー
1. **準備（バックログリファインメント）**
   - 未確定事項を洗い出し、Definition of Ready（DoR）を満たすまで要件を明確化。
   - 推定は相対ポイントまたは工数で行い、チームで共通理解を持つ。
2. **スプリント計画**
   - スプリントゴールを定義し、受け入れ基準・テスト観点を合意。
   - TDD 用テストケースやユースケースを先行してメモ化（テスト設計レビュー）。
3. **実装フェーズ**
   - デイリースタンドアップ（15 分以内）で進捗・阻害要因・当日計画を共有。
   - WIP（仕掛中）を制限し、未完了タスクの抱え込みを防止。
4. **スプリントレビュー**
   - 完了したインクリメントをデモし、実施したテスト結果・受け入れ可否を確認。
   - ステークホルダーのフィードバックを次バックログへ反映。
5. **振り返り（レトロスペクティブ）**
   - 「継続すべき」「改善すべき」「停止すべき」項目を定義し、改善アクションに責任者と期限を設定。
   - プロセス／技術の両面でメトリクス（例：テストカバレッジ、リードタイム）を評価する。

## 5. タスク管理と定義
- **バックログ構造**：エピック → ストーリー → タスクの粒度を推奨。技術負債や改善項目もバックログに含める。
- **Definition of Ready（DoR）** 例：
  - 目的と価値が明示されている。
  - 受け入れ基準がレビュー済み。
  - 依存タスクが洗い出されている。
- **Definition of Done（DoD）** 例：
  - TDD のテストが緑である。
  - コードレビュー／ペアレビュー済み。
  - ドキュメントと索引が更新されている。
  - 自動テスト・CI が成功している。
- **チケット運用**：カンバン状態は ToDo / In Progress / In Review / Done を基本とし、必要に応じて Blocked を追加。

## 6. TDD ワークフロー
1. **Red**：失敗する最小限のテストを書き、期待する振る舞いを明確化。
2. **Green**：テストを通す最小限の実装を行う。
3. **Refactor**：設計を整理し、重複や仮実装を改善する。リファクタリング後もテスト緑を保持。
- ユースケースや受け入れ基準からテストを派生させ、単体（Unit）→結合（Integration）→受け入れ（Acceptance）のレイヤーを構築。
- モック／スタブの利用ポリシーを明記し、外部依存はテストダブルで区切る。
- テストコードもレビュー対象とし、命名規約や AAA パターン（Arrange-Act-Assert）を統一。
- バグ修正時は再現テストを先に追加し、再発防止を保証する。

## 6.1 PM ブリーフ（エスカレーション）
- **担当者の手順**
  - バックログごとに PM への打ち上げが必要になった場合は `docs/operations/pm-briefs/<BacklogID>.md` を作成し、テンプレートに沿って記入する。
  - assignment ファイル（`docs/operations/agile/assignments/<BacklogID>.md`）から該当 PM ブリーフへのリンクを追記し、必要事項（背景、求める判断、希望期限、最新ステータス）を常に更新する。
  - スプリントジャーナルの「PM ブリーフ管理」欄に ID・概要・ステータスを記録し、進行中は日次でフォロー状況を更新する。
- **PM の手順**
  - 通知を受けたら `docs/operations/pm-briefs/<BacklogID>.md` を確認し、背景／課題、必要判断・リソース、希望期限が揃っているかチェックする。不足があれば担当者へ即時フィードバックする。
  - 対応開始時はステータスを `Follow-up` へ変更し、調整ログや意思決定のポイントを同ファイルに追記する。必要に応じて関係部署とのアクションを `information-requests.md` に記録する。
  - 判断完了後は `Resolved` に更新し、採った対応、フォローアップ期限、追加タスクの有無を明記する。関連する assignment やバックログ、スプリントジャーナルにも要約を反映し、チームへ共有する。

## 7. CI/CD とツール運用
- **バージョン管理**：Git を前提とし、`main`（安定）と短命ブランチ（タスク単位）で運用。長期的な diverge を避け、1〜2 日以内のマージを目指す。
- **CI パイプライン**：`lint` → `build` → `test` → `package` の順に自動化し、すべて CLI ベースで再現可能にする。
- **品質ゲート**：
  - 自動テスト成功。
  - 静的解析／リンター違反なし。
  - コードカバレッジ閾値（例：主要ロジック 80% 以上）を満たす。
- **リリース管理**：マイルストーンごとにタグ付けし、リリースノート（変更点・既知の問題・テスト結果）を作成。
- **ツール選定**：IDE 依存を避け、コマンドラインとエディタ拡張で完結する構成を基本とする。

## 8. ドキュメントとナレッジシェア
- ドキュメントはリポジトリ配下に統合し、索引用 README を常に最新化する。
- 主要ドキュメント（要件定義、設計、テスト計画、トラブルシューティング）はテンプレートを用意し、更新履歴を残す。
- 各バックログ ID（例: <BacklogID>）ごとに一次仕様書 `docs/operations/specs/<BacklogID>_<概要>.md` を作成し、DoR 完了前に目的・範囲・受け入れ基準・インタフェース・検証方針を明記する。仕様書を新設／更新した際は `docs/README.md` と関連ガイドライン（例: `<Project>_Development_Guidelines.md`）からの参照リンクを即時更新する。
- トラブル発生時は担当者が速やかに `docs/operations/troubleshooting/` 配下のバックログID別ファイルへ一次情報を追記し、必要なら新規ファイル（`troubleshooting_<BacklogID>_<概要>.md`）を作成して索引を更新する。
- 各バックログ ID（機能単位）には専用ジャーナル `docs/operations/agile/journals/<BacklogID>.md` を作成し、担当者全員が日次で作業内容・成果・検証結果・参照リンクを追記する。すべての作業履歴はバックログ個別ジャーナルで一元管理し、スプリント期間をまたいでも同じファイルへ追記する。
- スプリント単位の概要や意思決定は `docs/operations/agile/sprint-journal.md` に要約として記載し、各バックログジャーナルへのリンクとステータスサマリを整理する。デイリースタンドアップでは担当者が自身のジャーナル更新を確認し、PM はスプリントジャーナルのインデックスで全体状況を把握する。
- エラーや検証に伴う課題と対処結果は該当するトラブルシューティング文書にも追記し、再発防止に必要な一次情報を欠落させない。
- 情報要求や不明点は専用ログ（`docs/operations/information-requests.md`）に記録し、必要に応じて `docs/operations/work-orders/<ID>.md` の作業依頼書で具体的な手順・対象パス・成果物・フォローアップ方法を明文化する。調査時は利用可能な調査ツールを活用して根拠を明確化し、解決後は該当ドキュメントへ反映する。

### 8.1 `docs/` ディレクトリ構成ルール（共通）
- すべてのプロジェクトはルート直下に `docs/` ディレクトリを設け、本書に基づくプロセス関連ドキュメントをここへ集約する。
- `docs/` 配下の最低限の構成と役割は以下の通り。必要に応じて各プロジェクトの命名規則や追加資料を拡張してよいが、既存の責務を重複させないこと。

```
docs/
├─ README.md                             # 索引。追加・更新した文書は必ずここに反映する
├─ <Product>_Development_Guidelines.md   # 開発ガイドラインや命名ルール等の基準書
├─ operations/
│  ├─ agile_tdd_operating_rules.md       # 本ドキュメント（共通運用ルール）
│  ├─ information-requests.md            # 入手依頼の一覧とフォロー状況（必要に応じて work-orders とリンク）
│  ├─ agile/
│  │  ├─ product-backlog.md              # エピック／ストーリー／タスクの優先度管理
│  │  ├─ sprint-journal.md               # スプリント計画・進行ログの要約と各バックログジャーナルへのリンク集
│  │  ├─ action-items.md                 # 振り返りで決定した改善アクション
│  │  ├─ journals/                       # Backlog ID ごとの詳細作業ログ
│  │  │  └─ <BacklogID>.md                   # 担当者が日次で作業履歴・検証結果を追記する一次ジャーナル
│  │  └─ assignments/
│  │     └─ <BacklogID>.md               # 各担当者への指示書。PM ブリーフへのリンクと Backlog Sync フック設定手順（`git config core.hooksPath .githooks`）を必ず記載
│  ├─ specs/
│  │  ├─ README.md                       # 仕様テンプレートと命名規則（任意）。未整備の場合は本書の 8.2 節を参照
│  │  └─ <BacklogID>_<概要>.md               # バックログ ID ごとの一次仕様書（目的/受入基準/インタフェース/検証方針/改訂履歴を含む）
│  ├─ pm-briefs/
│  │  ├─ README.md                       # 打ち上げテンプレートの運用ガイド
│  │  └─ <BacklogID>.md                  # PM へのエスカレーション記録（Open/Follow-up/Resolved）
│  ├─ work-orders/
│  │  ├─ README.md                       # 作業依頼書の運用ガイドとテンプレート
│  │  └─ <ID>.md                         # 情報依頼やブリーフに紐づく詳細手順書
│  └─ troubleshooting/
│     └─ <BacklogID>_<概要>.md               # バックログID別のトラブルシューティングログ
└─ ...                                   # 仕様書・設計書などプロジェクト固有の資料
```

- プロジェクト固有のファイル名は `<Product>` や `<BacklogID>` を各チームの命名規則に置き換える。雛形を共通化することで、複数プロジェクト間での運用移管を容易にする。
- 指示書（assignments/<BacklogID>.md）は PM/PO が作成時に Backlog Sync フック設定手順とテンプレート (`docs/operations/templates/backlog_sync_hook.md`) への参照を含めること。欠落している場合はレビューで差し戻す。
- `docs/` の構成を変更する際は、`docs/README.md` の索引と本節を同時にアップデートし、全メンバーへ通知する。

### 8.2 バックログ仕様書（`docs/operations/specs/`）
- すべてのバックログ ID（<BacklogID> 等）は、着手前に `docs/operations/specs/<BacklogID>_<短い説明>.md` を作成して Definition of Ready を満たす。未整備の仕様書がある場合は、割り当てられた担当者が仕様策定を最優先で完了させる。
- 仕様書には最低限以下のセクションを含める: 目的／背景、スコープと非対象、入出力インタフェース・パラメータ、受け入れ基準、テスト・検証計画、依存関係、改訂履歴。テンプレートがない場合は `docs/operations/templates/` を参照するか、本節の要件を満たす形で新規テンプレートを作成する。
- `docs/operations/agile/product-backlog.md` および `assignments/<BacklogID>.md` から仕様書へのリンクを必須とし、ガイドライン類（`<Project>_Development_Guidelines.md` など）に影響する変更は該当ドキュメントへも反映する。リンク更新と `docs/README.md` の索引追記をセットで行い、レビューでは欠落していないか確認する。
- 仕様変更や検証結果に応じて仕様書を更新した際は、更新日・担当者・差分概要を改訂履歴へ追記し、必要に応じて PM ブリーフや情報依頼ログへ報告する。仕様書の整備状況はデイリーで共有し、未完了のバックログは DoR/DoD チェックリストを通過できないものとして扱う。

### 8.3 バックログ別ジャーナル（`docs/operations/agile/journals/`）
- 各 Backlog ID/機能につき 1 ファイル（例: `docs/operations/agile/journals/<BacklogID>.md`）を作成し、担当者が日次で時刻・担当・作業内容・成果物パス・参照チケット・検証結果を追記する。書式は `docs/operations/templates/backlog_journal.md`（未整備の場合は同テンプレートを作成）を用い、最低限「日付」「担当」「作業要約」「テスト／検証ログ」「次アクション」を記載する。
- バックログ別ジャーナルはスプリントをまたいで継続的に更新し、再利用性の高いノウハウや問題記録もこのファイルを起点にリンクする。作業履歴を他ファイルへ散逸させないこと。
- `sprint-journal.md` にはスプリントゴール、進捗サマリ、各バックログジャーナルへの直リンクを記載し、詳細ログは必ず該当 Backlog ID のファイルへ誘導する。PM／PO はスプリントジャーナルで全体の把握を行い、個別の深掘りはジャーナルファイルと assignments を参照する。
- バックログ別ジャーナルの更新はデイリースタンドアップおよびコードレビューで確認対象とし、記載漏れがあるタスクは `In Progress` から先へ進めない。DoD を満たすには当該ジャーナルが最新であることが必須。

### 8.4 配布パッケージ命名規則（`dist/`）

外部検証者や別チームへ配布するパッケージは、以下の命名規則に従う。

#### ディレクトリ構造
```
dist/
├─ <work-item-id>/                      # バックログ ID を小文字＋ハイフン区切りで命名
│  └─ <work-item-id>_package.tar.gz      # 正式配布パッケージ（ファイル名固定）
├─ <work-item-id>/
│  └─ <work-item-id>_package.tar.gz
└─ ...
```

#### 命名ルール
| 項目 | 規則 | 例 |
|------|------|-----|
| ディレクトリ名 | `<work-item-id>`（小文字＋ハイフン推奨） | `feature-101`, `task-42` |
| パッケージファイル名 | `<work-item-id>_package.tar.gz`（固定） | `feature-101_package.tar.gz` |

#### 重要な制約
- **ファイル名は固定**: 自動展開スクリプトが特定のファイル名に依存する場合があるため、バージョン番号や日付を付与しない。
- **ディレクトリ名とファイル名の対応**: ディレクトリ `<work-item-id>/` 内には `<work-item-id>_package.tar.gz` を配置し、ID の一致を必須とする。
- **旧ファイルの扱い**: 新しいパッケージを作成する際は、正式ファイル名で上書き保存する。履歴が必要な場合は Git の履歴で追跡する。

#### 自動展開スクリプトとの連携
自動展開スクリプトで扱う場合は、以下のような手順を前提にする：
```bash
tar -xzf <work-item-id>_package.tar.gz -C /path/to/target-directory
```
ファイル名が異なるとスクリプトが失敗するため、命名規則の遵守を徹底すること。

## 9. メトリクスと改善サイクル
- **フロー系**：リードタイム、サイクルタイム、WIP 数。
- **品質系**：欠陥検出密度、テストカバレッジ、リリース後不具合数。
- **チームヘルス**：ベロシティの推移、ペア／モブ開発の実施率、振り返りアクションの完遂率。
- 振り返りではメトリクスと定性的なフィードバックを組み合わせ、改善テーマを継続的に絞り込む。

## 10. 他プロジェクト導入時のチェックリスト
1. プロジェクトのミッションと重要指標（KPI/KGI）を定義したか。
2. DoR／DoD をチームで合意し、ツールに反映したか。
3. TDD を実践するためのテスト環境・テストフレームワークが整備されているか。
4. CI/CD パイプラインが設定済みで、ローカルと同じ手順で再現できるか。
5. ドキュメントの保管場所と索引更新ルールが確立しているか。
6. 振り返りで改善アクションを追跡する仕組み（例：アクションアイテムボード）があるか。
7. チームメンバー全員が本ルールを読み、適用方針に同意しているか。

---

## 11. テンプレートとチェックリスト

### 11.1 スプリント計画テンプレート
スプリント計画ミーティングでは下記テンプレートをコピーし、必要事項を記入する。コメント行は記入後に削除してよい。

```
### スプリント計画シート（スプリント <番号 or 期間>）

- スプリント期間: YYYY-MM-DD 〜 YYYY-MM-DD
- スプリントゴール: （価値仮説や完了条件を1〜2文で記載）
- 参加メンバー: PO / Dev / QA / SM 等

#### 1. バックログ選定
| ストーリーID | タイトル | 見積 (pt/時間) | 受け入れ基準概要 | 主要テスト観点 |
| --- | --- | --- | --- | --- |
| WORK-XXXX | 例: 認証フローの改善 | 5pt | ○○が満たされる | ○○テスト、境界値テスト |

- 想定ベロシティ: （前スプリント実績など）
- バッファ/余裕時間: （割合または時間で明記）

#### 2. テスト計画／準備
- 先行して作成するテストケース: （ユニット/統合/受け入れを列挙）
- 環境準備・依存関係: （SDK 更新、外部環境予約 等）

#### 3. リスクと対策
- 技術的リスク: （例: フレームワーク／言語バージョン差異）→ 対策
- プロセスリスク: （例: メンバー不在予定）→ 対策

#### 4. DoD 確認事項
- 本スプリントの DoD から特に注意すべき項目
- 完了後の検証・デモ方法

#### 5. 振り返りアクション引き継ぎ
- 前スプリントで決めた改善項目とオーナー／期限
```

### 11.2 Definition of Ready（DoR）チェックリスト
ストーリーやタスクを `In Progress` へ移動する前に、以下を必ず確認する。

- [ ] 目的と価値が1〜2文で明記されている。
- [ ] 受け入れ基準（AC）がレビュー済みで合意が取れている。
- [ ] テスト観点またはテストアイデアがメモされている。
- [ ] 依存ストーリーや外部チームとの調整事項が解消済み。
- [ ] 実装に必要なドキュメント／リファレンスがリンクされている。
- [ ] スコープ外事項が明示され、期待値が統一されている。
- [ ] 見積り（ポイント or 時間）がチームで合意済み。
- [ ] `docs/operations/agile/product-backlog.md` と担当 `docs/operations/agile/assignments/<BacklogID>.md` に DoR 情報（目的／AC／テスト観点／依存・参照リンク）が反映済みである。

### 11.3 Definition of Done（DoD）チェックリスト
Story/Task 完了時は下記チェックリストを使い、TDD と文書整備が満たされているか確認する。

- [ ] Red-Green-Refactor のテストサイクルを全て実施し、テストが緑である。
- [ ] 単体テスト・統合テストが自動化され、CI で成功している。
- [ ] コードレビュー／ペアレビューが完了し、指摘が反映済み。
- [ ] 仕様変更に伴うドキュメントが更新され、`docs/README.md` の索引も最新化されている。
- [ ] 当日実施した作業ログが該当バックログの `docs/operations/agile/journals/<BacklogID>.md` に追記され、関連するトラブルシューティング文書が更新済みである。
- [ ] 本書で定義したスプリント計画シートや振り返りアクションが更新済み。
- [ ] 実行ログや転送手順など再現性に必要な情報が共有場所に記録されている。
- [ ] リリース準備（タグ付け、リリースノート、検証結果共有）が完了、もしくは完了スケジュールが明記されている。
- [ ] `docs/operations/agile/product-backlog.md` の該当行と担当 `assignments/<BacklogID>.md` の作業メモ／KPI が完了内容に合わせて更新されている（レビュー／ステータス遷移前に必須）。

ToDo→In Progress への遷移は DoR チェックリストの全項目が ✅ になっていること、In Progress→Review/Done は DoD チェックリストに加えてバックログ＋assignment の更新が完了していることをデイリースタンドアップで確認する。未達の場合はステータス変更を保留し、PM ブリーフや情報依頼を通じて課題を解消する。

#### Backlog Sync 自動チェック
- `tools/check_backlog_sync.sh` を pre-commit / pre-push フックや CI の検証ステップで実行し、コード変更に対応するバックログ更新がステージされていない場合はエラーにする。
- 上記スクリプトは主要ディレクトリやガイドラインに差分があるにもかかわらず `docs/operations/agile/product-backlog.md` または `docs/operations/agile/assignments/<BacklogID>.md` が含まれていないコミットをブロックする。
- 手元で実行する場合は `./tools/check_backlog_sync.sh`。失敗メッセージに従って対象ファイルを更新し、再実行で通過したことを確認してからコミットする。
- リポジトリには `.githooks/pre-commit` / `.githooks/pre-push` が用意されている。`git config core.hooksPath .githooks` を実行して有効化し、全員同じチェックが動くようにすること。

> チーム事情に応じて、上記テンプレートやチェックリストに独自項目を追加してもよい。変更した場合はこのドキュメントに反映し、メンバー全員へ共有すること。

## 12. 成果物管理ルール (Deliverables)
各機能開発やスプリントで生成された配布用パッケージ、検証用アーカイブ、リリース成果物は、以下のルールに従って保存する。

1. **保存場所**: リポジトリルート直下の `dist/` ディレクトリを使用する。
2. **ディレクトリ構成**: 機能 ID またはバックログ ID ごとにサブディレクトリを作成し、そこへ成果物を配置する。ルート直下へのフラットな配置は禁止する。
3. **命名規則**: `dist/<Feature-ID>/` （例: `dist/<work-item-id>/`）。
4. **管理対象**:
   - 配布用 `.tar.gz` / `.zip` パッケージ
   - 検証時のスナップショット（再現性確保のため）
   - リリースバイナリ（必要な場合）

### 構成図
```
/
├─ dist/
│  ├─ <work-item-id>/               # 機能またはバックログ ID ごとの成果物
│  │  ├─ <work-item-id>_package.tar.gz
│  │  └─ ...
│  ├─ <work-item-id>/
│  │  └─ <work-item-id>_package.tar.gz
│  └─ <feature-id>/                 # 今後の機能追加用
└─ ...
```

---

### 運用と改訂
- 本文書はプロセス改善の一環として定期的に見直す。大幅な改訂はプロダクト責任者と開発リードの承認を得る。
- プロジェクト固有の補足ルールは別ドキュメントで管理し、本書からリンクする。
- 改訂履歴はファイル末尾またはリポジトリのコミットログで追跡可能にする。
