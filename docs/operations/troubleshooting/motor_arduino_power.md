# トラブルシューティング: モーター駆動時のArduino電源断

## TSB-MOT-001: モーター方向転換時にArduino電源断

### 問題の概要

モーターの方向転換（前進→後退など）を行うと、Arduinoが完全に電源断（LED消灯）する。

### 発生状況・再現手順

- **発生日**: 2026-02-15
- **環境**: バッテリー給電（Arduino・モーター共に同一バッテリー系統）
- **再現パターン**:
  1. `ros2 topic pub /cmd_vel` で前進コマンド送信（0.8秒）
  2. 停止後、後退コマンド送信（0.8秒）
  3. 後退動作中または直後にArduino LED消灯、シリアル通信不能

### 調査ログ

| 時刻 | 操作 | 結果 |
|------|------|------|
| 16:35頃 | 左旋回5秒 | 正常動作 |
| 16:47頃 | 右旋回3秒 | 正常動作 |
| 16:47頃 | 前進2秒 | 正常動作 |
| 16:50頃 | 全方向同時実行（スクリプト不具合で並列実行） | Arduino電源断（1回目） |
| 16:54頃 | 前進0.8秒→後退0.8秒（壁衝突→ストール） | Arduino電源断（2回目） |
| 17:02頃 | 回転テスト中・モーター非駆動時 | Arduino電源断（3回目） |

- 1回目・2回目: モーター高負荷時に発生
- 3回目: モーター非駆動時にも発生 → バッテリー残量不足の可能性大
- バッテリー残量確認手段なし

### 原因

**バッテリー電圧降下によるArduinoブラウンアウト**

主要な発生パターン:

1. **モーターストール（主原因）**
   - 壁や障害物に衝突して車輪がロックされた状態でモーターが回転を試み続ける
   - ストール電流は通常運転時の数倍〜十数倍に達する
   - 大電流でバッテリー電圧が急降下し、Arduinoが電源断
   - 2回目の発生（16:54頃）はこのパターン: 前進→壁衝突→ストール→電源断

2. **方向転換時の突入電流**
   - 4輪メカナムホイールのモーター全てが同時に逆転
   - 逆転時の突入電流（逆起電力 + 始動電流）が大きい
   - 1回目の発生（16:50頃）は全方向同時実行によるもの

- 全てのコンポーネントが同一バッテリーから給電されているため影響が直結する

### 対処方法

#### ソフトウェア対策（即時対応可能）

1. **方向転換前に停止コマンドを挿入し、待機時間を設ける**
   - 前進→停止（1秒待機）→後退の順で実行
   - モーターが完全に停止してから逆方向に回転させることで突入電流を軽減

2. **motor_controller_nodeに速度ランプ機能を追加**（将来対応）
   - 急激な速度変化を避け、段階的に速度を上下させる
   - cmd_velの値を直接コマンドに変換するのではなく、現在値から目標値へ徐々に変化

#### ハードウェア対策（将来検討）

1. **電解コンデンサの追加**
   - Arduino電源入力に大容量コンデンサ（470μF〜1000μF）を追加
   - 瞬間的な電圧降下を吸収

2. **電源系統の分離**
   - Arduinoの電源をモーターとは別系統にする（別のレギュレータまたは別バッテリー）

3. **バッテリー容量・放電能力の確認**
   - 充電状態を確認し、十分な容量があるか確認
   - 放電レートが十分か確認

### 再発防止策

- テストスクリプトでは方向転換前に必ず**STOP + 2秒待機**を挿入する
- 実運用でも急激な方向転換を避けるよう、Nav2のコントローラー設定で加減速を制限する
- バッテリー残量が少ない状態でのテストを避ける

### ステータス

- **ソフトウェア対策**: 対応中（テストスクリプト修正）
- **ハードウェア対策**: 未着手（将来検討）

---

## TSB-MOT-002: シリアルポート競合によるArduinoリセット

### 問題の概要

motor_controller_nodeがシリアルポートを使用中に、別プロセスから同じシリアルポートを開くとArduinoがリセットされる。

### 発生状況・再現手順

1. `ros2 launch zeuscar_bringup zeuscar.launch.py use_motor:=true` で起動
2. 別のPythonプロセスから `serial.Serial('/dev/arduino', 9600)` を実行
3. Arduino電源断

### 原因

- Arduinoのシリアルポートを開く際、DTR（Data Terminal Ready）信号が送られる
- DTR信号はArduinoのリセットピンに接続されており、ポートオープン時にArduinoがリセットされる
- motor_controller_nodeが既にポートを占有しているため、リソース競合も発生

### 対処方法

- **Arduinoのシリアルポートは常に1プロセスからのみアクセスすること**
- ROS2経由（`/cmd_vel` または `/zeuscar/motor_cmd` トピック）でのみモーター制御を行う
- デバッグ目的で直接シリアル通信を行う場合は、必ずmotor_controller_nodeを停止してから行う

### ステータス

解決済み（運用ルールで対応）
