# IMUテストレポート

- **日時**: 2026-02-03 21:15:45
- **テスト担当**: Claude Code
- **対象デバイス**: ICM-42688 6軸IMU
- **I2Cアドレス**: 0x68
- **I2Cバス**: 1

---

## 1. テスト環境

| 項目 | 値 |
|------|-----|
| ハードウェア | Raspberry Pi 4 |
| OS | Ubuntu 24.04 LTS |
| ROS 2 | Jazzy Jalisco |
| パッケージ | zeuscar_imu |
| テストノード | imu_test_node |

---

## 2. 検出・初期化結果

| 項目 | 結果 | 期待値 | 判定 |
|------|------|--------|------|
| WHO_AM_I | 0x47 | 0x47 | ✅ 正常 |
| ICM-42688検出 | 成功 | 成功 | ✅ 正常 |
| センサー初期化 | 成功 | 成功 | ✅ 正常 |

---

## 3. テストシーケンス結果

### 3.1 静止状態（基準値取得）
- **コマンド**: STOP
- **時間**: 2.0秒
- **サンプル数**: 20

| 測定項目 | 値 | 期待値 | 判定 |
|----------|-----|--------|------|
| accel_x | +0.001 g | ≈ 0 | ✅ 正常 |
| accel_y | +0.002 g | ≈ 0 | ✅ 正常 |
| accel_z | +0.126 g | +1.0 g | ⚠️ **異常** |
| gyro_x | -0.04 dps | ≈ 0 | ✅ 正常 |
| gyro_y | -0.05 dps | ≈ 0 | ✅ 正常 |
| gyro_z | +0.04 dps | ≈ 0 | ✅ 正常 |

### 3.2 前進テスト
- **コマンド**: FORWARD
- **時間**: 0.3秒
- **サンプル数**: 3

| 測定項目 | 値 | 期待 | 判定 |
|----------|-----|------|------|
| accel_x | +0.028 g | 正の変化 | ✅ 正常 |
| accel_y | +0.004 g | - | - |
| accel_z | +0.114 g | - | - |
| gyro_x | -0.45 dps | - | - |
| gyro_y | -1.08 dps | - | - |
| gyro_z | -0.09 dps | ≈ 0 | ✅ 正常 |

### 3.3 停止（前進後）
- **コマンド**: STOP
- **時間**: 1.0秒
- **サンプル数**: 10

| 測定項目 | 値 |
|----------|-----|
| accel_x | -0.002 g |
| accel_y | +0.004 g |
| accel_z | +0.131 g |
| gyro_x | -0.18 dps |
| gyro_y | +0.15 dps |
| gyro_z | -0.51 dps |

### 3.4 後退テスト
- **コマンド**: BACKWARD
- **時間**: 0.3秒
- **サンプル数**: 3

| 測定項目 | 値 | 期待 | 判定 |
|----------|-----|------|------|
| accel_x | -0.014 g | 負の変化 | ✅ 正常 |
| accel_y | +0.003 g | - | - |
| accel_z | +0.123 g | - | - |
| gyro_x | +0.73 dps | - | - |
| gyro_y | -0.19 dps | - | - |
| gyro_z | +0.62 dps | ≈ 0 | ✅ 正常 |

### 3.5 停止（後退後）
- **コマンド**: STOP
- **時間**: 1.0秒
- **サンプル数**: 10

| 測定項目 | 値 |
|----------|-----|
| accel_x | -0.000 g |
| accel_y | -0.005 g |
| accel_z | +0.126 g |
| gyro_x | -0.06 dps |
| gyro_y | -0.04 dps |
| gyro_z | +0.98 dps |

### 3.6 左旋回テスト
- **コマンド**: TURNLEFT
- **時間**: 0.3秒
- **サンプル数**: 3

| 測定項目 | 値 | 期待 | 判定 |
|----------|-----|------|------|
| accel_x | -0.008 g | - | - |
| accel_y | -0.007 g | - | - |
| accel_z | +0.116 g | - | - |
| gyro_x | -0.61 dps | - | - |
| gyro_y | +0.27 dps | - | - |
| gyro_z | +5.76 dps | 正の値 | ✅ 正常 |

### 3.7 停止（左旋回後）
- **コマンド**: STOP
- **時間**: 1.0秒
- **サンプル数**: 10

| 測定項目 | 値 |
|----------|-----|
| accel_x | +0.008 g |
| accel_y | +0.001 g |
| accel_z | +0.123 g |
| gyro_x | -0.01 dps |
| gyro_y | +0.09 dps |
| gyro_z | +4.13 dps |

### 3.8 右旋回テスト
- **コマンド**: TURNRIGHT
- **時間**: 0.3秒
- **サンプル数**: 3

| 測定項目 | 値 | 期待 | 判定 |
|----------|-----|------|------|
| accel_x | +0.007 g | - | - |
| accel_y | +0.004 g | - | - |
| accel_z | +0.140 g | - | - |
| gyro_x | -0.50 dps | - | - |
| gyro_y | -0.29 dps | - | - |
| gyro_z | -7.33 dps | 負の値 | ✅ 正常 |

### 3.9 停止（右旋回後）
- **コマンド**: STOP
- **時間**: 1.0秒
- **サンプル数**: 10

| 測定項目 | 値 |
|----------|-----|
| accel_x | +0.004 g |
| accel_y | -0.002 g |
| accel_z | +0.135 g |
| gyro_x | -0.24 dps |
| gyro_y | -0.05 dps |
| gyro_z | -3.38 dps |

---

## 4. 総合判定

| カテゴリ | 判定 | 備考 |
|----------|------|------|
| デバイス検出 | ✅ 正常 | WHO_AM_I = 0x47 |
| ジャイロスコープ | ✅ 正常 | 旋回方向の検出OK |
| 加速度計（X/Y） | ✅ 正常 | 前進/後退の検出OK |
| 加速度計（Z） | ⚠️ **異常** | 値が約1/8 |

**総合**: ⚠️ **要修正**（加速度スケールファクター）

---

## 5. 検出された問題

### 5.1 加速度Z軸の値が期待値の約1/8

**症状**:
- 静止状態でaccel_z ≈ +0.126g
- 期待値: +1.0g（重力）

**原因分析**:
センサー初期化コードとスケールファクターの不一致

```python
# 現在の設定（imu_test_node.py）
REG_ACCEL_CONFIG0 = 0x50
self._bus.write_byte_data(self.i2c_address, self.REG_ACCEL_CONFIG0, 0x06)
# 0x06 = 0b00000110
# - Bits 7:5 (ACCEL_FS_SEL) = 000 → ±16g
# - Bits 3:0 (ACCEL_ODR) = 0110 → 1kHz

ACCEL_SCALE = 16384.0  # ±2g用のスケールファクター
```

**問題**:
- レジスタ設定: ±16g（フルスケール）
- スケールファクター: 16384 LSB/g（±2g用）

±16gの場合、正しいスケールファクターは **2048 LSB/g**

**計算検証**:
- 測定値: 0.126g
- 補正後: 0.126 × (16384 / 2048) = 0.126 × 8 = 1.008g ✅

---

## 6. 推奨対応

### 方法1: スケールファクターを修正（推奨）
```python
# ±16g設定に合わせてスケールファクターを変更
ACCEL_SCALE = 2048.0  # ±16g設定時: 2048 LSB/g
```

### 方法2: レジスタ設定を±2gに変更
```python
# ACCEL_CONFIG0を±2g, 1kHzに設定
# 0x66 = 0b01100110
# - Bits 7:5 (ACCEL_FS_SEL) = 011 → ±2g
# - Bits 3:0 (ACCEL_ODR) = 0110 → 1kHz
self._bus.write_byte_data(self.i2c_address, self.REG_ACCEL_CONFIG0, 0x66)
```

---

## 7. 生ログ

```
[INFO] [1770120794.705655970] [imu_test_node]: === IMUセンサー動作確認テスト ===
[INFO] [1770120794.708441181] [imu_test_node]: I2Cバス: 1, アドレス: 0x68
[INFO] [1770120795.714439111] [imu_test_node]: WHO_AM_I: 0x47 (期待値: 0x47)
[INFO] [1770120795.717791501] [imu_test_node]: ICM-42688を検出しました
[INFO] [1770120795.824832213] [imu_test_node]: IMUを初期化しました
[INFO] [1770120795.827044782] [imu_test_node]:
[INFO] [1770120795.829306869] [imu_test_node]: === テスト開始 ===
[INFO] [1770120795.831565956] [imu_test_node]: ※ロボットが動きます。周囲に注意してください。
[INFO] [1770120795.833808839] [imu_test_node]:
[INFO] [1770120795.836347775] [imu_test_node]: --- 静止状態（基準値取得） (STOP, 2.0秒) ---
[INFO] [1770120797.906175826] [imu_test_node]: 静止状態（基準値取得） (サンプル数: 20):
  加速度平均 [g]: X=+0.001, Y=+0.002, Z=+0.126
  角速度平均 [dps]: X=-0.04, Y=-0.05, Z=+0.04
[INFO] [1770120797.908920889] [imu_test_node]:
[INFO] [1770120797.911367548] [imu_test_node]: --- 前進テスト (FORWARD, 0.3秒) ---
[INFO] [1770120798.223193753] [imu_test_node]: 前進テスト (サンプル数: 3):
  加速度平均 [g]: X=+0.028, Y=+0.004, Z=+0.114
  角速度平均 [dps]: X=-0.45, Y=-1.08, Z=-0.09
[INFO] [1770120798.226166314] [imu_test_node]:
[INFO] [1770120798.228313254] [imu_test_node]: --- 停止（前進後） (STOP, 1.0秒) ---
[INFO] [1770120799.260966449] [imu_test_node]: 停止（前進後） (サンプル数: 10):
  加速度平均 [g]: X=-0.002, Y=+0.004, Z=+0.131
  角速度平均 [dps]: X=-0.18, Y=+0.15, Z=-0.51
[INFO] [1770120799.264215544] [imu_test_node]:
[INFO] [1770120799.266639611] [imu_test_node]: --- 後退テスト (BACKWARD, 0.3秒) ---
[INFO] [1770120799.578185599] [imu_test_node]: 後退テスト (サンプル数: 3):
  加速度平均 [g]: X=-0.014, Y=+0.003, Z=+0.123
  角速度平均 [dps]: X=+0.73, Y=-0.19, Z=+0.62
[INFO] [1770120799.580781924] [imu_test_node]:
[INFO] [1770120799.583110436] [imu_test_node]: --- 停止（後退後） (STOP, 1.0秒) ---
[INFO] [1770120800.619933691] [imu_test_node]: 停止（後退後） (サンプル数: 10):
  加速度平均 [g]: X=-0.000, Y=-0.005, Z=+0.126
  角速度平均 [dps]: X=-0.06, Y=-0.04, Z=+0.98
[INFO] [1770120800.622336703] [imu_test_node]:
[INFO] [1770120800.624841639] [imu_test_node]: --- 左旋回テスト (TURNLEFT, 0.3秒) ---
[INFO] [1770120800.937984724] [imu_test_node]: 左旋回テスト (サンプル数: 3):
  加速度平均 [g]: X=-0.008, Y=-0.007, Z=+0.116
  角速度平均 [dps]: X=-0.61, Y=+0.27, Z=+5.76
[INFO] [1770120800.940609808] [imu_test_node]:
[INFO] [1770120800.943158188] [imu_test_node]: --- 停止（左旋回後） (STOP, 1.0秒) ---
[INFO] [1770120801.979887771] [imu_test_node]: 停止（左旋回後） (サンプル数: 10):
  加速度平均 [g]: X=+0.008, Y=+0.001, Z=+0.123
  角速度平均 [dps]: X=-0.01, Y=+0.09, Z=+4.13
[INFO] [1770120801.982878276] [imu_test_node]:
[INFO] [1770120801.986625163] [imu_test_node]: --- 右旋回テスト (TURNRIGHT, 0.3秒) ---
[INFO] [1770120802.298571895] [imu_test_node]: 右旋回テスト (サンプル数: 3):
  加速度平均 [g]: X=+0.007, Y=+0.004, Z=+0.140
  角速度平均 [dps]: X=-0.50, Y=-0.29, Z=-7.33
[INFO] [1770120802.301337884] [imu_test_node]:
[INFO] [1770120802.304316945] [imu_test_node]: --- 停止（右旋回後） (STOP, 1.0秒) ---
[INFO] [1770120803.340209160] [imu_test_node]: 停止（右旋回後） (サンプル数: 10):
  加速度平均 [g]: X=+0.004, Y=-0.002, Z=+0.135
  角速度平均 [dps]: X=-0.24, Y=-0.05, Z=-3.38
[INFO] [1770120803.343217536] [imu_test_node]:
[INFO] [1770120803.345452883] [imu_test_node]: === テスト完了 ===
[INFO] [1770120803.347699414] [imu_test_node]:
[INFO] [1770120803.350523310] [imu_test_node]: 【確認ポイント】
[INFO] [1770120803.353010432] [imu_test_node]: 1. 静止状態: accel_z ≈ +1.0g（重力）、gyro ≈ 0
[INFO] [1770120803.355581405] [imu_test_node]: 2. 前進/後退: accel_x に変化が見られるか
[INFO] [1770120803.358677169] [imu_test_node]: 3. 左旋回: gyro_z > 0、右旋回: gyro_z < 0
[INFO] [1770120803.362383148] [imu_test_node]: モーター停止、IMU接続クローズ
```

---

## 8. 次のアクション

- [ ] スケールファクターの修正（ACCEL_SCALE = 2048.0）
- [ ] 修正後の再テスト実施
- [ ] テスト結果の検証（accel_z ≈ 1.0g）
