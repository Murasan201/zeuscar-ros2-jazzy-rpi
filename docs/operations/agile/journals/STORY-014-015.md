# STORY-014/015: 統合bringup ジャーナル

## 概要

zeuscar_bringup パッケージの統合 launch ファイルを設計・実装し、全コンポーネント（TF, LiDAR, IMU, Motor, SLAM）を一括起動可能にする。

---

## 2026-02-07

### 担当: Claude Code (PM) + Agent Teams

### 作業体制

Agent Teams（in-process モード）を使用した TDD エージェント分離体制で実施。

| フェーズ | 担当 | 方式 |
|---------|------|------|
| 設計 | 設計エージェント（サブエージェント） | バックグラウンド実行 |
| テスト作成（Red） | test-writer（Agent Teams） | チームメイト |
| 実装（Green） | implementer（Agent Teams） | チームメイト |
| 統括・レビュー | team-lead（PM） | Agent Teams リーダー |

### 作業内容

#### 1. 設計フェーズ（設計エージェント）

- [x] 既存構成の調査（5パッケージの詳細棚卸し）
- [x] reference/ の旧プロジェクト（ROS 2 Humble版）参照
- [x] 統合launch設計（階層化構成、起動順序、グループ化）
- [x] テスト計画策定（6カテゴリ・26項目）
- [x] 設計仕様書作成（20KB）
- [x] 初心者向け実装ガイド作成（19KB）
- [x] docs/README.md 索引更新

**発見した課題**:
- URDFに `imu_link` が未定義（IMUノードは `imu_link` フレームを使用）
- → Phase 1 で追加が必要

#### 2. Red フェーズ（test-writer）

- [x] テストファイル作成（2ファイル・51テスト）
  - `test_urdf_imu_link.py`: 12テスト（URDF構造、TFツリー検証）
  - `test_launch_files.py`: 39テスト（launch構文、引数、条件付き起動）
- [x] テスト修正（ROS 2 Launch API の内部構造に合わせた修正）
  - `default_value` 比較: TextSubstitution の `.text` プロパティ使用
  - `_condition` 属性: publicプロパティ `condition` に変更

#### 3. Green フェーズ（implementer）

- [x] Phase 1: URDF修正（imu_link + base_link_to_imu ジョイント追加）
- [x] Phase 2: `robot_base.launch.py` 作成（TF + Motor 統合）
- [x] Phase 3: `sensors.launch.py` 作成（LiDAR + IMU 統合）
- [x] Phase 4: `zeuscar.launch.py` 作成（全体統合）
- [x] `setup.py` 更新（launch/ config/ ディレクトリ追加）
- [x] `config/zeuscar_params.yaml` 作成
- [x] 実装ガイドに実装フェーズの記録追記
- [x] テスト全パス確認: **51/51 passed**

### 成果物

| 種類 | パス | 説明 |
|------|------|------|
| 仕様書 | `docs/operations/specs/STORY-014-015_bringup_design.md` | 設計仕様書 |
| ガイド | `docs/guides/bringup_integration_guide.md` | 初心者向け実装ガイド |
| テスト | `ros2_ws/src/zeuscar_bringup/test/test_urdf_imu_link.py` | URDF テスト（12件） |
| テスト | `ros2_ws/src/zeuscar_bringup/test/test_launch_files.py` | Launch テスト（39件） |
| URDF | `ros2_ws/src/zeuscar_description/urdf/zeuscar.urdf.xacro` | imu_link 追加 |
| Launch | `ros2_ws/src/zeuscar_bringup/launch/robot_base.launch.py` | TF + Motor 統合 |
| Launch | `ros2_ws/src/zeuscar_bringup/launch/sensors.launch.py` | LiDAR + IMU 統合 |
| Launch | `ros2_ws/src/zeuscar_bringup/launch/zeuscar.launch.py` | 全体統合 |
| Config | `ros2_ws/src/zeuscar_bringup/config/zeuscar_params.yaml` | パラメータファイル |

### 統合launch構成

```
zeuscar.launch.py（全体統合）
├── robot_base.launch.py
│   ├── description.launch.py（TF/URDF）
│   └── motor.launch.py（条件付き: use_motor）
├── sensors.launch.py
│   ├── lidar.launch.py（条件付き: use_lidar）
│   └── imu.launch.py（条件付き: use_imu）
├── slam.launch.py（条件付き: use_slam）
└── rviz2（条件付き: use_rviz）
```

### Launch Arguments

| 引数 | デフォルト | 説明 |
|------|-----------|------|
| use_sim_time | false | シミュレーション時間使用 |
| use_lidar | true | LiDAR 有効化 |
| use_imu | true | IMU 有効化 |
| use_motor | true | モーター有効化 |
| use_slam | false | SLAM 有効化 |
| use_rviz | false | RViz 有効化 |
| serial_port_lidar | /dev/rplidar | LiDAR シリアルポート |
| serial_port_motor | /dev/ttyACM0 | Arduino シリアルポート |

### Agent Teams 運用の振り返り

**うまくいった点**:
- タスク依存関係（blockedBy）で Red → Green の順序を自動的に強制できた
- test-writer と implementer 間の直接メッセージでテスト設計意図を共有できた
- ビューワー（Shift+↑）で各エージェントの進捗を可視化できた

**改善点**:
- テストの API 前提不整合（TextSubstitution、_condition）が Red フェーズで検出できず、Green フェーズで発覚
- → テスト作成時に実際のROS 2 API でスモークテストを実行すべき

### 次のアクション

- [ ] 実機統合テスト（全センサー + モーター接続状態で `ros2 launch zeuscar_bringup zeuscar.launch.py`）
- [x] STORY-014/015 バックログ更新（Done）
- [ ] GITHUB_TOKEN 更新後にリモートプッシュ

---

## 2026-02-08

### 担当: Claude Code (PM)

### 作業内容

#### 実機統合テスト実施

テスト計画書（`docs/operations/specs/integration_test_plan.md`）に基づき、6ステージのテストを実施。

##### ステージ 0: 事前確認 - 合格
- ハードウェア: /dev/rplidar (ttyUSB0), /dev/arduino (ttyACM0), I2C 0x68 全て検出
- ソフトウェア: 6パッケージ全てビルド成功

##### ステージ 1: 最小構成（TF のみ）- 合格
- robot_state_publisher 正常起動
- TFツリー確認: base_footprint → base_link → laser_frame, imu_link

##### ステージ 2: センサー追加テスト - 合格
- S2-1 TF + LiDAR: /scan 約 5.9 Hz, frame_id=laser_frame
- S2-2 TF + IMU: /imu/data_raw, linear_acceleration.z=10.02 m/s², orientation_covariance[0]=-1.0
- S2-3 TF + LiDAR + IMU 同時: 3ノード正常動作、/scan 約 6.6 Hz

##### ステージ 3: モーター追加テスト - 合格
- S3-1 TF + Motor: motor_controller_node 起動、シリアル接続 /dev/ttyACM0 @ 9600bps
- S3-2 モーター動作確認: cmd_vel 前進→停止コマンド送受信成功（車輪浮かせ状態で実施）

##### ステージ 4: 全機能統合テスト - 条件付き合格
- **問題発見**: `zeuscar.launch.py` による全ノード同時起動では rplidar_node が /scan を配信しない（TSB-INT-003）
- **回避策**: robot_base.launch.py → sensors.launch.py の段階的起動で全機能動作を確認
- S4-1 段階的起動: 4ノード全起動、全トピック配信確認
- S4-2 TFツリー: base_footprint→base_link→laser_frame, imu_link 全接続確認
- S4-3 センサー品質: /scan 約 6.6 Hz 安定、/imu/data_raw 約 50.0 Hz 安定
- S4-4 3分間安定性: ノード全生存、データ配信継続

##### ステージ 5: Launch Arguments 動作テスト - 合格
- S5-1 use_lidar:=false: LiDAR 不起動、他ノード正常
- S5-2 use_imu:=false: IMU 不起動、他ノード正常
- S5-3 use_motor:=false: Motor 不起動、他ノード正常

### 検出された問題

| ID | 問題 | 重要度 | 対応状況 |
|----|------|--------|---------|
| TSB-INT-001 | /tf_static の QoS 不一致 | 低 | 解決済（QoSオプション指定） |
| TSB-INT-002 | プロセス残存によるノード重複 | 中 | 解決済（クリーンアップ手順確立） |
| TSB-INT-003 | 全機能同時起動時の LiDAR 初期化失敗 | 高 | 解決済（TimerAction による3秒遅延起動を導入） |

### テスト結果サマリー

| ステージ | テスト内容 | 結果 |
|---------|---------|------|
| S0 | 事前確認 | 合格 |
| S1 | 最小構成（TF のみ） | 合格 |
| S2 | センサー追加（LiDAR + IMU） | 合格 |
| S3 | モーター追加 | 合格 |
| S4 | 全機能統合 | 合格（TimerAction導入後、一発起動で全ノード正常動作） |
| S5 | Launch Arguments 動作確認 | 合格 |

**総合判定: 合格**

全コンポーネントの単独および組み合わせ動作は正常。統合 launch の同時起動問題（TSB-INT-003）は TimerAction 導入により解決し、`zeuscar.launch.py` の一発起動で全ノード正常動作を確認済み。

### 次のアクション

- [x] TSB-INT-003 対策: zeuscar.launch.py に TimerAction を導入し、センサー起動を3秒遅延（55/55テストパス）
- [x] テスト結果を技術ガイド・設計仕様書に反映
- [x] TimerAction 導入後の実機確認（2026-02-08: 一発起動で4ノード全正常動作、/scan・/imu配信確認）
- [x] 変更を git commit してリモートにプッシュ
- [ ] オドメトリ生成（robot_localization パッケージ）→ SLAM 動作確認（STORY-011）

#### TSB-INT-003 対策の実装（TDD）

- テスト作成（Red）: `test_launch_files.py` に4テスト追加
  - `test_has_sensor_startup_delay_arg`
  - `test_sensor_startup_delay_default_value`
  - `test_has_timer_action`
  - `test_timer_action_contains_sensors_launch`
- 実装（Green）: `zeuscar.launch.py` に `TimerAction` + `sensor_startup_delay` 引数追加
- テスト結果: 55/55 パス（launch 43 + URDF 12）
- ドキュメント更新: トラブルシューティング（解決済）、設計仕様書、実装ガイド

---

## STORY-014/015 完了サマリー

- 全テスト 55/55 パス（launch 43 + URDF 12）
- 実機統合テスト S0-S5 全合格
- TSB-INT-001〜003 全て解決済
- `zeuscar.launch.py` 一発起動で全ノード正常動作確認済み
- ドキュメント（設計仕様書、実装ガイド、テスト計画書、トラブルシューティング）全て更新済み

### 次のタスク

- [ ] STORY-011: オドメトリ生成（robot_localization パッケージ）→ SLAM 動作確認
  - EPIC-004（SLAM構築）の前提条件としてオドメトリソースが必要
  - IMU データ（/imu/data_raw）は利用可能、ホイールオドメトリは未実装
