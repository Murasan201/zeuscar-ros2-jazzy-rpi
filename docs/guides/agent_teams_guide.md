# Claude Code Agent Teams ガイド

Claude Code Agent Teams は、Opus 4.6 と同時にリリースされた実験的機能である。
複数の Claude Code インスタンスが並列で協調動作する仕組みで、1つのセッションが「チームリード」として他の「チームメイト」にタスクを割り振り、結果を統合する。

> **調査日**: 2026-02-07
> **ステータス**: 実験的機能（Experimental）

---

## 1. 概要

従来のサブエージェント（単一セッション内で子プロセスを起動する方式）とは異なり、Agent Teams のチームメイトは**完全に独立した Claude Code インスタンス**として動作する。チームメイト同士がリードを介さずに**直接メッセージ交換**できる点が最大の特徴である。

### サブエージェントとの違い

| 観点 | Agent Teams | サブエージェント |
|------|-----------|--------------|
| プロセス | 独立した Claude Code インスタンス | 単一セッション内の子プロセス |
| コンテキスト | チームメイトごとに独立 | 呼び出し元とは独立だが結果のみ返却 |
| 通信 | チームメイト間で直接メッセージ交換可能 | 呼び出し元への報告のみ |
| トークンコスト | 最も高い（チームメイト数に比例） | 中程度 |
| セッション再開 | 制限あり（チームメイトは復元されない） | フルサポート |

---

## 2. 有効化方法

Agent Teams はデフォルトで無効であり、明示的に有効化する必要がある。

### 環境変数

```bash
export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1
```

### settings.json

```json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

---

## 3. アーキテクチャ

### コンポーネント

| コンポーネント | 役割 |
|------------|------|
| **Team Lead** | チームの作成、チームメイトの生成、タスク振り分け、結果統合を行うメインセッション |
| **Teammates** | 各自が独立したコンテキストウィンドウを持つ別プロセスの Claude Code インスタンス |
| **Task List** | 共有タスクリスト（pending / in_progress / completed） |
| **Mailbox** | チームメイト間の直接メッセージシステム（自動配信、ポーリング不要） |

### チームメイトの特徴

- 独立したコンテキストウィンドウを持つ
- プロジェクトコンテキスト（CLAUDE.md、MCPサーバー、スキル）は自動ロードされる
- リードの会話履歴は**引き継がない**
- リードからのスポーンプロンプトを受け取る
- 完了時にリードへ自動通知する

### データ保存場所

- チーム設定: `~/.claude/teams/{team-name}/config.json`
- タスクリスト: `~/.claude/tasks/{team-name}/`

---

## 4. 使い方

### チーム作成

自然言語でリードに指示する。

```
このリファクタリングを並列で進めるチームを作成して。
UX担当、アーキテクチャ担当、テスト担当の3名で。
```

### 表示モード

| モード | 説明 | 要件 |
|-------|------|------|
| `in-process`（デフォルト） | 1つのターミナルに全チームメイトを表示 | 特になし |
| `tmux` | 分割ペインで各チームメイトを個別表示 | tmux or iTerm2 |
| `auto` | tmux内ならsplit、それ以外はin-process | - |

コマンドラインオプション:

```bash
claude --teammate-mode in-process
claude --teammate-mode tmux
```

### キー操作（in-process モード）

| キー | 操作 |
|-----|------|
| Shift+Up/Down | チームメイト選択 |
| Enter | 選択中のセッション全画面表示 |
| Escape | 中断 |
| Ctrl+T | タスクリスト表示切替 |
| Shift+Tab | Delegate Mode 切替 |

### Delegate Mode

Shift+Tab で切替可能。リードを**調整専任**にし、コード実装を禁止する。
リードはチームメイトの生成・メッセージ送受信・タスク管理のみを行う。

### プラン承認ゲート

変更前にプランの承認を必須にできる。

```
認証モジュールのリファクタリングをするチームメイトを生成して。
変更前にプラン承認を必須にして。
```

チームメイトが計画を完了するとリードに承認リクエストが送信される。リードは承認またはフィードバック付きで差し戻しを行う。

### タスク管理

- リードが明示的にアサイン、またはチームメイトが自動的にクレーム（取得）
- タスクの依存関係を自動管理（前提タスク完了で自動アンブロック）
- ファイルロックで競合を防止

### チーム管理コマンド

```
# 特定のチームメイトにメッセージ
セキュリティ担当のチームメイトに進捗を聞いて

# 全員にブロードキャスト
全チームメイトにコーディング規約のリマインダーを送って

# チームメイトの終了
調査担当のチームメイトを終了して

# チーム全体のクリーンアップ
チームをクリーンアップして
```

---

## 5. フック（品質管理）

| フック | タイミング | exit code 2 の効果 |
|-------|----------|-------------------|
| `TeammateIdle` | チームメイトがアイドルになる前 | フィードバックを送り作業継続を強制 |
| `TaskCompleted` | タスクが完了マークされた時 | 完了を差し戻してフィードバックを送信 |

---

## 6. 制限事項

### セッション管理

- `/resume` や `/rewind` でチームメイトは復元されない
- 再開後は新しいチームメイトを生成する必要がある

### チーム構造

- 1セッション = 1チームのみ
- ネストチーム不可（チームメイトが自分のチームを作ることはできない）
- リードは固定（チームメイトへのリーダーシップ移譲不可）

### ファイル競合

- 同一ファイルを複数チームメイトが編集すると上書き競合が発生する
- チームメイトごとに担当ファイルを明確に分離する必要がある

### 表示モード

- tmux 分割ペインは VS Code 統合ターミナル、Windows Terminal、Ghostty では非対応
- macOS での tmux が最も安定

### トークンコスト

- チームメイト数に比例してトークン消費が増大
- 単純な逐次タスクには単一セッションの方がコスト効率が良い

---

## 7. 使い分けガイドライン

### Agent Teams が適するケース

- 複数の視点で並列にコードレビュー・調査を行いたい場合
- チームメイト間の議論・協調が価値を生む場合
- 独立した複数モジュールの並列実装
- 複数仮説の同時検証（デバッグ等）

### サブエージェントが適するケース

- 結果だけが必要な集中型タスク
- トークンコストを抑えたい場合
- 短時間で完了する分離タスク

### 単一セッションが適するケース

- 逐次的な作業
- 依存関係が多く並列化のメリットが少ない場合
- コスト最小化が最優先の場合

---

## 8. ベストプラクティス

### タスク設計

- **適切な粒度**: 小さすぎると調整コストが上回り、大きすぎるとチェックイン不足になる
- **目安**: チームメイト1名あたり5〜6タスクが生産的
- **ファイル分離**: チームメイトごとに担当ファイルを明確に分けてファイル競合を回避

### コンテキスト準備

- チームメイトはリードの会話履歴を引き継がない
- スポーンプロンプトにタスク固有の詳細を含める
- CLAUDE.md でプロジェクト共通のガイダンスを提供

スポーンプロンプトの例:

```
セキュリティレビュー担当のチームメイトを生成してください。プロンプト:
「src/auth/ の認証モジュールをセキュリティ脆弱性の観点でレビューしてください。
トークン管理、セッション管理、入力バリデーションに注目。
アプリは JWT トークンを httpOnly Cookie に保存しています。
問題を重要度付きで報告してください。」
```

### 運用パターン

1. **まず調査・レビューから始める**: 明確な境界のあるタスクで慣れる
2. **品質ゲートを設定**: フック（TeammateIdle, TaskCompleted）で品質を担保
3. **定期的に進捗確認**: チームメイトを長時間放置しない
4. **Delegate Mode の活用**: リードをオーケストレーション専任にして分離を徹底

---

## 参考資料

- [Claude Code Agent Teams 公式ドキュメント](https://code.claude.com/docs/en/agent-teams.md)
- [Anthropic - Building a C compiler with parallel Claudes](https://www.anthropic.com/engineering/building-c-compiler)

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-07 | 初版作成（調査結果に基づく） |
