# ZeusCar SLAM設定ファイル
# slam_toolbox用のパラメータ設定
#
# 注意: 本設定は初期テンプレートです。
# 実際の環境でテスト後、パラメータの調整が必要になる場合があります。
#
# 参考: /opt/ros/jazzy/share/slam_toolbox/config/mapper_params_online_async.yaml

slam_toolbox:
  ros__parameters:

    # ソルバー設定
    solver_plugin: solver_plugins::CeresSolver
    ceres_linear_solver: SPARSE_NORMAL_CHOLESKY
    ceres_preconditioner: SCHUR_JACOBI
    ceres_trust_strategy: LEVENBERG_MARQUARDT
    ceres_dogleg_type: TRADITIONAL_DOGLEG
    ceres_loss_function: None

    # フレーム設定（ZeusCar TFツリーに合わせて設定）
    odom_frame: odom
    map_frame: map
    base_frame: base_footprint
    scan_topic: /scan
    use_map_saver: true
    mode: mapping  # mapping または localization

    # マップファイル設定（継続マッピング時に使用）
    # map_file_name: zeuscar_map
    # map_start_pose: [0.0, 0.0, 0.0]
    # map_start_at_dock: true

    # デバッグ・パフォーマンス設定
    debug_logging: false
    throttle_scans: 1
    transform_publish_period: 0.02  # TF更新周期（秒）
    map_update_interval: 5.0        # マップ更新間隔（秒）
    resolution: 0.05                # マップ解像度（メートル/ピクセル）
    max_laser_range: 12.0           # RPLIDAR A1M8の最大距離
    minimum_time_interval: 0.5      # スキャン間の最小時間間隔
    transform_timeout: 0.5          # TF変換タイムアウト（RPi4用に緩和）
    tf_buffer_duration: 15.0        # TFバッファ保持時間（メモリ節約）
    stack_size_to_use: 10000000     # スタックサイズ（RPi4: 40MB→10MBに削減）
    enable_interactive_mode: false  # RViz未使用のため無効化（メモリ節約）

    # スキャンマッチング設定
    use_scan_matching: true
    use_scan_barycenter: true
    minimum_travel_distance: 0.3    # 更新に必要な最小移動距離（メートル）
    minimum_travel_heading: 0.3     # 更新に必要な最小回転角（ラジアン）
    scan_buffer_size: 10
    scan_buffer_maximum_scan_distance: 10.0
    link_match_minimum_response_fine: 0.1
    link_scan_maximum_distance: 1.5

    # ループクロージャ設定
    loop_search_maximum_distance: 3.0
    do_loop_closing: true
    loop_match_minimum_chain_size: 10
    loop_match_maximum_variance_coarse: 3.0
    loop_match_minimum_response_coarse: 0.35
    loop_match_minimum_response_fine: 0.45

    # 相関パラメータ
    correlation_search_space_dimension: 0.5
    correlation_search_space_resolution: 0.01
    correlation_search_space_smear_deviation: 0.1

    # ループクロージャ用相関パラメータ
    loop_search_space_dimension: 8.0
    loop_search_space_resolution: 0.05
    loop_search_space_smear_deviation: 0.03

    # スキャンマッチャーパラメータ
    distance_variance_penalty: 0.5
    angle_variance_penalty: 1.0
    fine_search_angle_offset: 0.00349
    coarse_search_angle_offset: 0.349
    coarse_angle_resolution: 0.0349
    minimum_angle_penalty: 0.9
    minimum_distance_penalty: 0.5
    use_response_expansion: true
    min_pass_through: 2
    occupancy_threshold: 0.1
